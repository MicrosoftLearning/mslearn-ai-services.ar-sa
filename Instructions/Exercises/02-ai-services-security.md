---
lab:
  title: إدارة أمان خدمات الذكاء الاصطناعي في Azure
  module: Module 2 - Developing AI Apps with Azure AI Services
---

# إدارة أمان خدمات الذكاء الاصطناعي في Azure

يعد الأمان أحد الاعتبارات الهامة لأي تطبيق، وباعتبارك مطورًا يجب عليك التأكد من أن الوصول إلى الموارد مثل أمان خدمات الذكاء الاصطناعي في Azure يقتصر فقط على أولئك الذين يحتاجون إليه.

عادة ما يتم التحكم في الوصول إلى خدمات الذكاء الاصطناعي في Azure من خلال مفاتيح المصادقة، والتي يتم إنشاؤها عند إنشاء مورد خدمات الذكاء الاصطناعي في Azure في البداية.

## استنساخ المستودع في التعليمة البرمجية في Visual Studio 

ستقوم بتطوير تطبيقك باستخدام التعليمة البرمجية في Visual Studio. تم توفير ملفات التعليمات البرمجية لتطبيقك في GitHub repo.

> **تلميح**: إذا كنت قد استنسخت **بالفعل مستودع mslearn-ai-services** مؤخرًا، فافتحه في التعليمة البرمجية في Visual Studio. وإلا فاتبع هذه الخطوات لاستنساخه إلى بيئة تطويرك.

1. ابدأ تشغيل Visual Studio Code.
2. افتح لوحة (SHIFT+CTRL+P) وشغّل **Git: استنسخ الأمر ** لاستنساخ مستودع `https://github.com/MicrosoftLearning/mslearn-ai-services` إلى مجلد محلي (لا يُهم أي مجلد).
3. عند استنساخ المستودع، افتح المجلد في تعليمة Visual Studio البرمجية.
4. انتظر حتى تثبيت ملفات إضافية لدعم مشاريع التعليمات البرمجية C# في المستودع عند الضرورة

    > **ملاحظة**: إذا جرت مطالبتك بإضافة الأصول المطلوبة للبناء وتصحيح الأخطاء، فحدد **ليس الآن**.

5. وسّع المجلد `Labfiles/02-ai-services-security`.

أنجز توفير التعليمات البرمجية لكل من C# وPython. وسّع مجلد اللغة المفضلة لديك.

## توفير مورد خدمات الذكاء الاصطناعي في Azure

إذا لم يكن لديك بالفعل مورد في اشتراكك، فسيتعين عليك توفير مورد **خدمات الذكاء الاصطناعي في Azure**.

1. افتح مدخل Azure على `https://portal.azure.com`، وسجل الدخول باستخدام حساب Microsoft المقترن باشتراك Azure.
2. في شريط البحث العلوي، ابحث عن *خدمات الذكاء الاصطناعي في Azure*، وحدد **خدمات الذكاء الاصطناعي في Azure**، وأنشئ مورد حساب متعدد الخدمات لخدمات الذكاء الاصطناعي في Azure بالإعدادات التالية:
    - **Subscription**: *اشتراكك في Azure*
    - **مجموعة الموارد**: *اختر أو أنشئ مجموعة موارد (إذا كنت تستخدم اشتراكًا مقيدًا، فقد لا يكون لديك إذن لإنشاء مجموعة موارد جديدة - استخدم المجموعة المتوفرة)*
    - **المنطقة**: *اختر أي منطقة متوفرة*
    - **الاسم**: *أدخل اسماً فريداً*
    - **مستوى التسعير**: قياسي S0
3. حدد مربعات الاختيار المطلوبة ثم أنشئ المورد.
4. انتظر حتى يكتمل النشر، ثم اعرض تفاصيل النشر.

## تنظيم مفاتيح المصادقة

عند إنشاء مورد خدمات الذكاء الاصطناعي في Azure، تم إنشاء مفتاحي مصادقة. يمكنك إدارة هذه في مدخل Microsoft Azure أو باستخدام واجهة سطر الأوامر Azure (CLI). 

1. اختر طريقة واحدة للحصول على مفاتيح المصادقة ونقطة النهاية: 

    **استخدام بوابة Azure**: في بوابة Azure، انتقل إلى مورد خدمات الذكاء الاصطناعي في Azure واعرض صفحة **المفاتيح ونقاط النهاية** الخاصة به. تحتوي هذه الصفحة على المعلومات المطلوبة للاتصال بموردك واستخدامه من التطبيقات التي تطورها. على وجه التحديد:
    - *نقطة نهاية* HTTP التي بمقدور تطبيقات العميل إرسال الطلبات إليها.
    - *مفتاحان* بالمقدور استخدامهما لتحقيق المصادقة (يمكن لتطبيقات العميل استخدام أي من المفاتيح. ومن الممارسات المعروفة استخدام واحد للتطوير، وآخر للإنتاج. يمكنك بسهولة ويسر إعادة إنشاء مفتاح التطوير بعد انتهاء المطورين من عملهم لمنع الوصول المستمر).
    - *الموقع* الذي ينجز فيه استضافة المورد. هذا مطلوب للطلبات لبعض (وليس جميع) واجهات برمجة التطبيقات (API).

    **استخدام سطر الأوامر**: بدلًا من ذلك، يمكنك استخدام الأمر التالي للحصول على قائمة مفاتيح خدمات الذكاء الاصطناعي في Azure. في التعليمة البرمجية لـ Visual Studio، افتح محطة طرفية جديدة. ثم قم بلصق الأمر التالي؛ مع استبدال *&lt;resourceName&gt;* باسم مورد خدمات الذكاء الاصطناعي في Azure، و*&lt;resourceGroup&gt;* باسم مجموعة الموارد التي قمت بإنشائها فيها.

    ```
    az cognitiveservices account keys list --name <resourceName> --resource-group <resourceGroup>
    ```

    يقوم الأمر بإرجاع قائمة بالمفاتيح لمورد خدمات الذكاء الاصطناعي في Azure- هناك مفتاحان، يسمى **مفتاح 1** و**مفتاح 2**.

    > **تلميح**: إذا لم تقم بمصادقة Azure CLI بعد، فشغّل أولًا `az login` وسجّل الدخول إلى حسابك.

2. لاختبار خدمة الذكاء الاصطناعي في Azure، يمكنك استخدام **curl** - أداة سطر أوامر لطلبات HTTP. في المجلد**02-ai-services-security**، افتح **rest-test.cmd** وقم بتحرير الأمر** curl ** يحتوي عليه (الموضح أدناه)، واستبدل *&lt; نقطة النهاية &gt;* و*&lt;مفتاحك&gt;* بنقطة النهاية URI ومفتاح**مفتاح 1** لاستخدام واجهة برمجة تطبيقات تحليل النص في مورد خدمات الذكاء الاصطناعي في Azure. 

    ```bash
    curl -X POST "<yourEndpoint>/language/:analyze-text?api-version=2023-04-01" -H "Content-Type: application/json" -H "Ocp-Apim-Subscription-Key: <your-key>" --data-ascii "{'analysisInput':{'documents':[{'id':1,'text':'hello'}]}, 'kind': 'LanguageDetection'}"
    ```

3. احفظ تغييراتك. في المحطة الطرفية، انتقل إلى المجلد "02-ai-services-security". (**ملاحظة**: يمكنك القيام بذلك بالنقر بزر الماوس الأيمن فوق المجلد 02-ai-services-security" في مستكشفك، وتحديد *فتح في المحطة الطرفية المدمجة*). ثم شغَّل الأمر التالي:

    ```
    ./rest-test.cmd
    ```

يرجع الأمر مستند JSON يحتوي على معلومات حول اللغة المكتشفة في بيانات الإدخال (والتي يجب أن تكون الإنجليزية).

4. إذا تعرض أحد المفاتيح للخطر، أو لم يعد المطورون الذين لديهم يتطلبون الوصول، يمكنك إعادة إنشائه في المدخل أو باستخدام واجهة سطر الأوامر Azure. قم بتشغيل الأمر التالي لإعادة إنشاء مفتاح **مفتاح 1**مفتاح (استبدال*&lt;اسم المورد&gt;* و*&lt;مجموعة المورد&gt;* لموردك).

    ```
    az cognitiveservices account keys regenerate --name <resourceName> --resource-group <resourceGroup> --key-name key1
    ```

يتم إرجاع قائمة المفاتيح لمورد خدمات الذكاء الاصطناعي في Azure - لاحظ أن **مفتاح 1** قد تغير منذ آخر استرداد لها.

5. أعد تشغيل الأمر** rest-test** باستخدام المفتاح القديم (يمكنك استخدام السهم **^** الموجود على لوحة المفاتيح للتنقل بين الأوامر السابقة)، والتحقق من توقفه الآن.
6. قم بتحرير *curl* الأمر في**rest-test.cmd** استبدال المفتاح بـ**مفتاح 1** وقيمة جديدتين، واحفظ التغييرات. ثم أعد تشغيل **الأمر rest-test** وتحقق من نجاحه.

> **تلميح**: في هذا التمرين، استخدمت الأسماء الكاملة لمعلمات واجهة سطر الأوامر Azure ، مثل **--resource-group**.  يمكنك أيضا استخدام بدائل أقصر، مثل **-g**، لتقليل الإسهاب في الأوامر (ولكن من الصعب فهمها).  يسرد [مرجع أمر واجهة سطر الأوامر في خدمات الذكاء الاصطناعي في Azure ](https://docs.microsoft.com/cli/azure/cognitiveservices?view=azure-cli-latest)خيارات المعلمات لكل أمر واجهة سطر الأوامر في خدمات الذكاء الاصطناعي في Azure.

## تأمين إمكانية الوصول إلى المفتاح باستخدام Azure Key Vault

يمكنك تطوير التطبيقات التي تستهلك خدمات الذكاء الاصطناعي في Azure باستخدام مفتاح للمصادقة. ولكن هذا يعني أن التعليمات البرمجية للتطبيق يجب أن تكون قادرة على الحصول على المفتاح. أحد الخيارات تتمثل في تخزين المفتاح في متغير بيئة أو ملف تكوين حيث يتم نشر التطبيق، ولكن هذا النهج يترك المفتاح عرضة للوصول غير المصرح به. تتمثل الطريقة الفضلى عند تطوير التطبيقات على Azure في تخزين المفتاح بأمان في Azure Key Vault، وتوفير الوصول إلى المفتاح من خلال *هوية* مدارة (بمعنى آخر، حساب مستخدم يستخدمه التطبيق نفسه).

### إعداد مخزن مفاتيح وإضافة بيانات سرية

أولا، تحتاج إلى إنشاء مخزن مفاتيح وإضافة *سر* لمفتاح خدمات الذكاء الاصطناعي في Azure.

1. دون قيمة **المفتاح 1** لمورد خدمات الذكاء الاصطناعي في Azure (أو انسخها إلى الحافظة).
2. في مدخل Microsoft Azure، في الصفحة**الصفحة الرئيسية**، حدد **&65291; أنشئ زر مورد**، وابحث عن *Key Vault*، وأنشئ مورد**Key Vault** بالإعدادات التالية:

    - علامة تبويب**Basics**
        - **Subscription**: *اشتراكك في Azure*
        - **مجموعة الموارد**: *مجموعة الموارد نفسها مثل مورد خدمة الذكاء الاصطناعي في Azure*
        - **اسم Key vault**: *أدخل اسماً فريداً*
        - **المنطقة**: *نفس المنطقة مثل مورد خدمة الذكاء الاصطناعي في Azure خاصتك*
        - **مستوى الأسعار**: قياسي
    
    - علامة تبويب**تكوين الوصول**
        -  **نموذج إذن**: سياسة الوصول إلى المخزن
        - مرر لأسفل إلى قسم **سياسات الوصول** وحدد المستخدم باستخدام خانة الاختيار على اليسار. ثم حدد **مراجعة+إنشاء**، وحدد **إنشاء** لإنشاء المورد الخاص بك.
     
3. انتظر حتى يكتمل التوزيع، ثم انتقل إلى مورد key vault.
4. في جزء التنقل الأيسر، حدد «**البيانات السرية**» (في المقطع «الإعدادات»).
5. حدد **+إنشاء/استيراد** وأضف سرا جديدا بالإعدادات التالية:
    - **خيارات التحميل**: يدوي
    - **الاسم**: مفتاح خدمات الذكاء الاصطناعي *(من المهم أن تتطابق مع هذا تمامًا، لأنك ستقوم لاحقًا بتشغيل التعليمات البرمجية التي تسترد البيانات السرية استنادًا إلى هذا الاسم)*
    - **قيمة السر**: * **مفاتحك1** مفتاح خدمات الذكاء الاصطناعي في Azure*
6. حدد **إنشاء**.

### إنشاء كيان خدمة

للوصول إلى السر في مخزن المفاتيح، يجب أن يستخدم تطبيقك كيان خدمة به حق الوصول إلى البيانات السرية. ستستخدم واجهة سطر أوامر Azure (CLI) لإنشاء كيان الخدمة، والعثور على معرف الكائن الخاص به، ومنح حق الوصول إلى البيانات السرية في Azure Vault.

1. قم بتشغيل أمر Azure CLI التالي، مع استبدال *&lt; spName*&gt; باسم مناسب فريد لهوية التطبيق (على سبيل المثال، *ai-app* مع إلحاق الأحرف الأولى من اسمك في النهاية؛ يجب أن يكون الاسم فريدًا داخل المستأجر الخاص بك). استبدل ايضًا *&lt;معرف الاشتراك&gt;* و*&lt;مجموعة الموارد&gt;* بالقيم الصحيحة لمعرف الاشتراك ومجموعة الموارد التي تحتوي على خدمات الذكاء الاصطناعي في Azure وموارد key vault:

    > **تلميح**: إذا لم تكن متأكدا من معرف الاشتراك الخاص بك، فاستخدم الأمر **إظهار الحساب az** لاسترداد معلومات اشتراكك - معرف الاشتراك هو سمة **المعرف** في الإخراج. في حالة رؤيتك خطأ فيما يخص العنصر الموجود بالفعل، فيرجى اختيار اسم فريد مختلف.

    ```
    az ad sp create-for-rbac -n "api://<spName>" --role owner --scopes subscriptions/<subscriptionId>/resourceGroups/<resourceGroup>
    ```

يتضمن إخراج هذا الأمر معلومات بشأن كيان الخدمة الجديد. يجب أن يبدو مشابهًا لهذا:

    ```
    {
        "appId": "abcd12345efghi67890jklmn",
        "displayName": "api://ai-app-",
        "password": "1a2b3c4d5e6f7g8h9i0j",
        "tenant": "1234abcd5678fghi90jklm"
    }
    ```

دوّن **معرف التطبيق**و**كلمة المرور**و**المستأجر** - ستحتاج إليها لاحقا (إذا قمت بإغلاق المحطة الطرفية هذه، فلن تتمكن من استرداد كلمة المرور؛ لذلك من المهم ملاحظة القيم الآن - يمكنك لصق الإخراج في ملف نصي جديد على جهازك المحلي للتأكد من أنه يمكنك العثور على القيم التي تحتاج إليها لاحقا!)

2. للحصول على **معرف العنصر** الخاص بكيان الخدمة، قم بتشغيل أمر سطر أوامر Azure التالي، واستبدال&lt; *معرف التطبيق&gt;* بقيمة معرف تطبيق كيان الخدمة.

    ```
    az ad sp show --id <appId>
    ```

3. انسخ القيمة `id` في json الذي تم إرجاعه استجابة لذلك. 
3. لتعيين إذن لكيان الخدمة الجديد للوصول إلى الأسرار في Key Vault، قم بتشغيل أمر سطر أوامر Azure التالي، واستبدل*&lt; keyVaultName &gt;* باسم مورد Azure Key Vault و*&lt;معرف العتصر&gt;* بقيمة معرف كيان الخدمة الذي نسخته للتو. 

    ```
    az keyvault set-policy -n <keyVaultName> --object-id <objectId> --secret-permissions get list
    ```

### استعمال كيان الخدمة في تطبيق ما

أصبحت الآن جاهزًا لاستخدام الهوية الأساسية للخدمة في أحد التطبيقات، حتى تتمكن من الوصول إلى مفتاح خدمات الذكاء الاصطناعي في Azure السري في مخزن المفاتيح الخاص بك واستخدامه للاتصال بمورد خدمات الذكاء الاصطناعي في Azure.

> **ملاحظة**: في هذا التمرين، سنقوم بتخزين بيانات اعتماد كيان الخدمة في تكوين التطبيق واستخدامها لمصادقة هوية **ClientSecretCredential** في التعليمات البرمجية للتطبيق الخاص بك. هذا أمر جيد للتطوير والاختبار، ولكن في تطبيق إنتاج حقيقي، سيقوم المسؤول بتعيين *هوية مدارة*للتطبيق بحيث يستخدم الهوية الأساسية للخدمة للوصول إلى الموارد، دون التخزين المؤقت أو تخزين كلمة المرور.

1. في المحطة الطرفية، قم بالتبديل إلى المجلد ** C-Sharp** أو **Python** استنادا إلى تفضيلات اللغة الخاصة بك عن طريق تشغيل `cd C-Sharp` أو `cd Python`. ثم شغّل `cd keyvault_client` للانتقال إلى مجلد التطبيق.
2. ثبّت الحزم التي ستحتاج إلى استخدامها لـAzure Key Vault وواجهة برمجة تطبيقات تحليلات النص في مورد خدمات الذكاء الاصطناعي في Azure عن طريق تشغيل الأمر المناسب لتفضيل اللغة:

    **C#**

    ```
    dotnet add package Azure.AI.TextAnalytics --version 5.3.0
    dotnet add package Azure.Identity --version 1.12.0
    dotnet add package Azure.Security.KeyVault.Secrets --version 4.6.0
    ```

    **Python**

    ```
    pip install azure-ai-textanalytics==5.3.0
    pip install azure-identity==1.17.1
    pip install azure-keyvault-secrets==4.8.0
    ```

3. اعرض محتويات مجلد **keyvault-client**، ولاحظ أنه يحتوي على ملف لإعدادات التكوين:
    - **C#**: appsettings.json
    - **Python**: .env

    افتح ملف التكوين وقم بتحديث قيم التكوين التي يحتوي عليها لتعكس الإعدادات المذكورة أدناه:
    
    - **نقطة النهاية** لمورد خدمات الذكاء الاصطناعي في Azure
    - اسم مورد ** Azure Key Vault**
    - **المستأجر** لمدير الخدمة الخاص بك
    - **معرف التطبيق** لكيان الخدمة
    - **كلمة المرور** لكيان الخدمة

     احفظ التغييرات بالنقر فوق **CTRL+S**.
4. لاحظ أن المجلد **keyvault-client** يحتوي على ملف تعليمات برمجية لتطبيق العميل:

    - **C#**: Program.cs
    - **Python**: keyvault-client.py

    افتح ملف التعليمات البرمجية وراجع التعليمات البرمجية التي يحتوي عليها، مع ملاحظة التفاصيل التالية:
    - يتم استيراد مساحة الاسم SDK المثبتة من جانبك
    - تقوم التعليمات البرمجية في الدالة **الأساسية** باسترداد إعدادات تكوين التطبيق، ثم تستخدم بيانات اعتماد كيان الخدمة للحصول على مفتاح خدمات الذكاء الاصطناعي في Azure من مخزن المفاتيح.
    - تستخدم الدلة ** GetLanguage** SDK لإنشاء عميل للخدمة، ثم تستخدم العميل للكشف عن لغة النص المدخل.
5. أدخل الأمر التالي لتشغل البرنامج:

    **C#**

    ```
    dotnet run
    ```

    **Python**

    ```
    python keyvault-client.py
    ```

6. عند المطالبة، أدخل نصا وراجع اللغة التي تم اكتشافها عن طريق الخدمة. على سبيل المثال، حاول إدخال "Hello" و"Bonjour" و"Gracias".
7. عند إنهاء اختبار التطبيق، أدخل "إنهاء" لإيقاف البرنامج.

## تنظيف الموارد

إذا كنت لا تستخدم موارد Azure التي أنشأتها في هذا المختبر لوحدات التدريب الأخرى، فيمكنك حذفها لتجنب تكبد المزيد من الرسوم.

1. افتح مدخل Azure في `https://portal.azure.com`، وفي شريط البحث العلوي، ابحث عن الموارد التي أنشأتها في هذا المختبر.

2. في صفحة المورد، حدد **حذف** واتبع الإرشادات لحذف المورد. بدلاً من ذلك، يمكنك حذف مجموعة الموارد بأكملها لتنظيف جميع الموارد في الوقت نفسه.

## مزيد من المعلومات

لمزيد من المعلومات حول تأمين خدمات الذكاء الاصطناعي في Azure، راجع [وثائق أمان خدمات الذكاء الاصطناعي في Azure](https://docs.microsoft.com/azure/ai-services/security-features).
